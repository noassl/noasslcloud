services:
  ntfy:
    image: binwiederhier/ntfy
    container_name: ntfy
    command:
      - serve
    environment:
      - TZ=Europe/Vienna
    env_file:
      - .env
    volumes:
      - /var/cache/ntfy:/var/cache/ntfy
      - /var/lib/ntfy:/var/lib/ntfy
      - ./server.yml:/etc/ntfy/server.yml
    ports:
     - "25:25" # SMTP Server
    healthcheck:
      test: [ "CMD-SHELL", "wget -q --tries=1 http://localhost:80/v1/health -O - | grep -Eo '\"healthy\"\\s*:\\s*true' || exit 1" ]
      interval: 60s
      timeout: 10s
      retries: 3
      start_period: 40s
    init: true # needed if healthcheck is used. Prevents zombie processes
    restart: unless-stopped
    labels:
      traefik.enable: true
      traefik.http.routers.ntfy.rule: "Host(`notify.noassl.at`)"
      traefik.http.routers.ntfy.entryPoints: "websecure"
      traefik.http.routers.ntfy.tls: true
      traefik.http.routers.ntfy.tls.certresolver: "letsencrypt"
      traefik.http.services.ntfy.loadbalancer.server.port: 80
    networks:
      - traefik

networks:
  traefik:
    external: true
